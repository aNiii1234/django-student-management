{% extends 'base.html' %}
{% load static %}
{% block title %}管理员面板 - 学生信息管理系统{% endblock %}

{% block extra_css %}
<style>
/* 统计卡片样式优化 */
.stats-card {
    transition: all 0.3s ease;
    min-height: 160px;
}

.stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15) !important;
}

/* 统计卡片间距调整 */
.stats-section {
    margin-bottom: 2rem;
}

/* 大屏幕上调整间距 */
@media (min-width: 992px) {
    .stats-card-wrapper {
        padding: 0 10px;
    }
}

/* 中等屏幕上调整间距 */
@media (min-width: 768px) and (max-width: 991.98px) {
    .stats-card-wrapper {
        padding: 0 8px;
        margin-bottom: 1rem;
    }
}

/* 小屏幕上调整 */
@media (max-width: 767.98px) {
    .stats-card-wrapper {
        margin-bottom: 1rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-tachometer-alt"></i> 管理员面板</h2>
        <hr>
    </div>
</div>

<!-- 新用户提示 -->
{% if students_without_profiles_count > 0 %}
<div class="row">
    <div class="col-12">
        <div class="alert alert-warning alert-dismissible" role="alert">
            <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-triangle fa-lg me-3"></i>
                <div>
                    <h6 class="alert-heading mb-1">待处理的学生档案</h6>
                    <p class="mb-2">
                        有 <strong>{{ students_without_profiles_count }}</strong> 位学生用户还没有创建学生档案。
                        请尽快为他们创建档案，以便学生能够正常使用系统。
                    </p>
                    <a href="{% url 'accounts:pending_student_profiles' %}" class="btn btn-sm btn-warning">
                        <i class="fas fa-user-plus"></i> 立即处理
                    </a>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="alert alert-info alert-dismissible" role="alert">
            <h6 class="alert-heading"><i class="fas fa-users"></i> 最近注册的新用户</h6>
            <div class="row">
                {% for user in recent_users|slice:":3" %}
                <div class="col-md-4">
                    <small>
                        <strong>{{ user.get_full_name|default:user.username }}</strong>
                        <span class="badge {% if user.role == 'admin' %}bg-danger{% elif user.role == 'student' %}bg-success{% else %}bg-info{% endif %} ms-1">
                            {{ user.get_role_display }}
                        </span><br>
                        注册时间：{{ user.created_at|date:"m-d H:i" }}
                    </small>
                </div>
                {% empty %}
                <div class="col-12">
                    <small class="text-muted">最近3天内没有新用户注册</small>
                </div>
                {% endfor %}
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>
</div>
{% endif %}

<!-- 统计卡片区域 -->
<div class="stats-section">
    <div class="row">
        <div class="col-md-4 col-lg-4 stats-card-wrapper mb-4">
            <a href="{% url 'accounts:user_list' %}" class="text-decoration-none">
                <div class="card text-center bg-primary text-white clickable-card stats-card">
                    <div class="card-body d-flex flex-column justify-content-center p-4">
                        <h5 class="card-title mb-3"><i class="fas fa-users"></i> 总用户数</h5>
                        <h2 class="mb-3">{{ total_users }}</h2>
                        <small><i class="fas fa-arrow-right"></i> 点击查看所有用户</small>
                    </div>
                </div>
            </a>
        </div>

        <div class="col-md-4 col-lg-4 stats-card-wrapper mb-4">
            <a href="{% url 'accounts:user_list' %}?type=students" class="text-decoration-none">
                <div class="card text-center bg-success text-white clickable-card stats-card">
                    <div class="card-body d-flex flex-column justify-content-center p-4">
                        <h5 class="card-title mb-3"><i class="fas fa-user-graduate"></i> 学生总数</h5>
                        <h2 class="mb-3">{{ total_students }}</h2>
                        <small><i class="fas fa-arrow-right"></i> 点击查看学生用户</small>
                    </div>
                </div>
            </a>
        </div>

        <div class="col-md-4 col-lg-4 stats-card-wrapper mb-4">
            <a href="{% url 'accounts:student_profile_list_admin' %}" class="text-decoration-none">
                <div class="card text-center bg-warning text-white clickable-card stats-card">
                    <div class="card-body d-flex flex-column justify-content-center p-4">
                        <h5 class="card-title mb-3"><i class="fas fa-id-card"></i> 学生档案</h5>
                        <h2 class="mb-3">{{ total_student_profiles }}</h2>
                        <small><i class="fas fa-arrow-right"></i> 点击查看学生档案</small>
                    </div>
                </div>
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <h4><i class="fas fa-cogs"></i> 快速操作</h4>
        <hr>
    </div>
</div>

<div class="row">
    <div class="col-md-6 mb-3">
        <div class="list-group">
            <h6 class="list-group-item active"><i class="fas fa-users"></i> 用户管理</h6>
            <a href="{% url 'accounts:user_list' %}" class="list-group-item list-group-item-action">
                <i class="fas fa-users text-primary"></i> 所有用户
                <small class="text-muted">查看和管理系统所有用户 ({{ total_users }})</small>
                <span class="badge bg-primary float-end">{{ total_users }}</span>
            </a>
            <a href="{% url 'accounts:user_list' %}?type=students" class="list-group-item list-group-item-action">
                <i class="fas fa-user-graduate text-success"></i> 学生用户
                <small class="text-muted">查看和管理学生用户 ({{ total_students }})</small>
                <span class="badge bg-success float-end">{{ total_students }}</span>
            </a>
            <a href="{% url 'accounts:pending_student_profiles' %}" class="list-group-item list-group-item-action {% if students_without_profiles_count > 0 %}list-group-item-warning{% endif %}">
                <i class="fas fa-exclamation-triangle {% if students_without_profiles_count > 0 %}text-warning{% else %}text-secondary{% endif %}"></i> 待处理学生档案
                <small class="text-muted">为无档案学生创建档案 ({{ students_without_profiles_count }})</small>
                {% if students_without_profiles_count > 0 %}
                <span class="badge bg-warning float-end">{{ students_without_profiles_count }}</span>
                {% endif %}
            </a>
        </div>
    </div>

    <div class="col-md-6 mb-3">
        <div class="list-group">
            <h6 class="list-group-item active"><i class="fas fa-cogs"></i> 系统管理</h6>
            <a href="{% url 'students:student_profile_list' %}" class="list-group-item list-group-item-action">
                <i class="fas fa-id-card text-primary"></i> 学生档案管理
                <small class="text-muted">管理学生档案和信息 ({{ total_student_profiles }})</small>
                <span class="badge bg-primary float-end">{{ total_student_profiles }}</span>
            </a>
            <a href="{% url 'students:department_list' %}" class="list-group-item list-group-item-action">
                <i class="fas fa-university text-success"></i> 院系管理
                <small class="text-muted">管理院系信息</small>
            </a>
            <a href="{% url 'students:major_list' %}" class="list-group-item list-group-item-action">
                <i class="fas fa-book-open text-info"></i> 专业管理
                <small class="text-muted">管理专业信息</small>
            </a>
            <a href="{% url 'students:course_list' %}" class="list-group-item list-group-item-action">
                <i class="fas fa-book text-warning"></i> 课程管理
                <small class="text-muted">管理课程信息</small>
            </a>
            <a href="{% url 'students:enrollment_list' %}" class="list-group-item list-group-item-action">
                <i class="fas fa-graduation-cap text-primary"></i> 选课管理
                <small class="text-muted">管理学生选课记录</small>
            </a>
            <a href="{% url 'students:enrollment_grade_list' %}" class="list-group-item list-group-item-action">
                <i class="fas fa-chart-line text-success"></i> 成绩管理
                <small class="text-muted">录入和管理学生成绩</small>
            </a>
        </div>
    </div>
</div>

<!-- 添加最近注册用户详细信息区域 -->
{% if recent_users %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-clock"></i> 最近注册的新用户</h5>
                <a href="{% url 'accounts:user_list' %}" class="btn btn-sm btn-outline-primary">查看全部用户</a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>学号</th>
                                <th>姓名</th>
                                <th>邮箱</th>
                                <th>角色</th>
                                <th>注册时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in recent_users|slice:":5" %}
                            <tr>
                                <td><strong>{{ user.username }}</strong></td>
                                <td>{{ user.get_full_name|default:"未设置" }}</td>
                                <td>{{ user.email }}</td>
                                <td>
                                    <span class="badge {% if user.role == 'admin' %}bg-danger{% elif user.role == 'student' %}bg-success{% else %}bg-info{% endif %}">
                                        {{ user.get_role_display }}
                                    </span>
                                </td>
                                <td>{{ user.created_at|date:"Y-m-d H:i" }}</td>
                                <td>
                                    {% if user.role == 'student' %}
                                        {% if not user.studentprofile_set.exists %}
                                            <a href="{% url 'accounts:quick_create_student_profile' user.id %}" class="btn btn-sm btn-outline-warning">
                                                <i class="fas fa-user-plus"></i> 创建档案
                                            </a>
                                        {% else %}
                                            <span class="text-success"><i class="fas fa-check"></i> 已有档案</span>
                                        {% endif %}
                                    {% endif %}
                                    <a href="{% url 'accounts:edit_user' user.id %}" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center text-muted">最近没有新用户注册</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- 待处理学生档案快速链接 -->
{% if students_without_profiles_count > 0 %}
<div class="row">
    <div class="col-12">
        <div class="list-group">
            <a href="{% url 'accounts:pending_student_profiles' %}" class="list-group-item list-group-item-action list-group-item-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>待处理学生档案 ({{ students_without_profiles_count }})</strong>
                <small class="text-muted">点击为注册学生创建档案</small>
            </a>
        </div>
    </div>
</div>
{% endif %}
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> 系统信息</h5>
            </div>
            <div class="card-body">
                <p class="mb-1"><strong>管理员学号：</strong> {{ user.username }}</p>
                <p class="mb-1"><strong>邮箱：</strong> {{ user.email }}</p>
                <p class="mb-1"><strong>登录时间：</strong> {% now 'Y-m-d H:i:s' %}</p>
                <p class="mb-0"><strong>系统版本：</strong> 学生信息管理系统 v1.0</p>
                <p class="mb-0 mt-2">
                    <small class="text-muted">
                        <i class="fas fa-sync"></i> 实时同步已启用
                        <span id="last-sync-time" class="ms-1">--:--:--</span>
                        <button id="manual-refresh" class="btn btn-sm btn-outline-secondary ms-2">
                            <i class="fas fa-sync"></i> 手动刷新
                        </button>
                    </small>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- 实时同步JavaScript -->
<script src="/static/js/realtime_sync.js"></script>
<script>
// 为统计数据添加ID以便JavaScript更新
document.addEventListener('DOMContentLoaded', function() {
    // 为统计卡片添加ID
    const totalUsersEl = document.querySelector('.card-body h2');
    const totalStudentsEl = totalUsersEl ? totalUsersEl.parentElement.parentElement.querySelector('.col-md-4:nth-child(2) .card-body h2') : null;

    // 更新现有统计元素的ID
    const statsElements = document.querySelectorAll('.card-body h2');
    if (statsElements.length >= 3) {
        statsElements[0].id = 'total-users';
        statsElements[1].id = 'total-students';
        statsElements[2].id = 'total-student-profiles';
    }

    // 为待处理档案数量添加ID
    const pendingBadge = document.querySelector('.badge.bg-warning');
    if (pendingBadge) {
        pendingBadge.id = 'pending-profiles-badge';
    }
});
</script>
{% endblock %}