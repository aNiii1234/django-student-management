{% extends 'base.html' %}
{% block title %}选择课程 - 学生信息管理系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h3><i class="fas fa-book"></i> 选择课程</h3>
        <hr>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-list"></i> 可选课程列表</h5>
            </div>
            <div class="card-body">
                {% if available_courses %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>课程名称</th>
                                    <th>课程代码</th>
                                    <th>课程类型</th>
                                    <th>学分</th>
                                    <th>学时</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for course in available_courses %}
                                    <tr>
                                        <td>
                                            <strong>{{ course.name }}</strong>
                                            {% if course.description %}
                                                <br><small class="text-muted">{{ course.description|truncatechars:50 }}</small>
                                            {% endif %}
                                        </td>
                                        <td>{{ course.code }}</td>
                                        <td>
                                            <span class="badge {% if course.course_type == 'required' %}bg-primary{% elif course.course_type == 'elective' %}bg-success{% else %}bg-info{% endif %}">
                                                {{ course.get_course_type_display }}
                                            </span>
                                        </td>
                                        <td>{{ course.credits }}</td>
                                        <td>{{ course.hours }}</td>
                                        <td>
                                            <button type="button" class="btn btn-success btn-sm"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#enrollModal"
                                                    onclick="selectCourse({{ course.id }}, '{{ course.name }}', '{{ course.code }}')">
                                                <i class="fas fa-plus"></i> 选择
                                            </button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-book fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">暂无可选课程</h4>
                        <p class="text-muted">目前没有新的课程可供选择，或您已选择所有可用课程。</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card bg-light">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> 选课说明</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="fas fa-check text-success"></i> 只能选择当前学期开设的课程
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success"></i> 不能重复选择已选过的课程
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success"></i> 选课后需要等待管理员审核
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success"></i> 选课成功后可在"我的课程"中查看
                    </li>
                    <li>
                        <i class="fas fa-check text-success"></i> 如有问题请联系教务管理员
                    </li>
                </ul>
            </div>
        </div>

        <div class="card bg-warning text-dark mt-3">
            <div class="card-header">
                <h5><i class="fas fa-exclamation-triangle"></i> 注意事项</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="fas fa-warning"></i> 请仔细阅读课程信息
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-warning"></i> 选课前确认课程符合培养计划
                    </li>
                    <li>
                        <i class="fas fa-warning"></i> 选课一旦提交，无法自行取消
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- 选课确认模态框 -->
<div class="modal fade" id="enrollModal" tabindex="-1" aria-labelledby="enrollModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="enrollModalLabel">
                    <i class="fas fa-check-circle"></i> 确认选课
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>您确定要选择以下课程吗？</p>
                <div class="alert alert-light">
                    <div class="row">
                        <div class="col-md-4"><strong>课程名称：</strong></div>
                        <div class="col-md-8" id="modalCourseName"></div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-4"><strong>课程代码：</strong></div>
                        <div class="col-md-8" id="modalCourseCode"></div>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="{{ form.semester.id_for_label }}" class="form-label">{{ form.semester.label }}</label>
                    {{ form.semester }}
                    {% if form.semester.errors %}
                        <div class="text-danger">
                            {{ form.semester.errors.0 }}
                        </div>
                    {% endif %}
                    <small class="form-text text-muted">请根据您的学年进度选择对应的学期</small>
                </div>

                <div class="mb-3">
                    <label for="{{ form.academic_year.id_for_label }}" class="form-label">{{ form.academic_year.label }}</label>
                    {{ form.academic_year }}
                    {% if form.academic_year.errors %}
                        <div class="text-danger">
                            {{ form.academic_year.errors.0 }}
                        </div>
                    {% endif %}
                    <small class="form-text text-muted">选择课程开设的学年</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> 取消
                </button>
                <button type="button" class="btn btn-primary" onclick="submitEnrollment()">
                    <i class="fas fa-check"></i> 确认选课
                </button>
            </div>
        </div>
    </div>
</div>

<form id="enrollmentForm" method="post" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="course" id="selectedCourse">
    <input type="hidden" name="semester" id="submittedSemester">
    <input type="hidden" name="academic_year" id="submittedAcademicYear">
</form>

<script>
let selectedCourseId = null;
let selectedCourseName = '';
let selectedCourseCode = '';

function selectCourse(courseId, courseName, courseCode) {
    selectedCourseId = courseId;
    selectedCourseName = courseName;
    selectedCourseCode = courseCode;

    document.getElementById('modalCourseName').textContent = courseName;
    document.getElementById('modalCourseCode').textContent = courseCode;
}

function submitEnrollment() {
    const semester = document.getElementById('{{ form.semester.id_for_label }}').value;
    const academicYear = document.getElementById('{{ form.academic_year.id_for_label }}').value;

    if (!semester) {
        alert('请选择学期！');
        return;
    }

    if (!academicYear) {
        alert('请选择学年！');
        return;
    }

    if (!selectedCourseId) {
        alert('请先选择课程！');
        return;
    }

    // 设置表单数据
    document.getElementById('selectedCourse').value = selectedCourseId;
    document.getElementById('submittedSemester').value = semester;
    document.getElementById('submittedAcademicYear').value = academicYear;

    // 提交表单
    const form = document.getElementById('enrollmentForm');
    form.action = '{% url "students:course_selection_submit" %}';
    form.submit();
}

// 设置当前学年和推荐学期
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth() + 1; // getMonth() 返回 0-11

    // 设置学年默认值
    const academicYearSelect = document.getElementById('{{ form.academic_year.id_for_label }}');
    if (academicYearSelect) {
        const academicYear = `${currentYear}-${currentYear + 1}`;
        // 查找匹配的学年选项并设置为默认
        for (let i = 0; i < academicYearSelect.options.length; i++) {
            if (academicYearSelect.options[i].value === academicYear) {
                academicYearSelect.options[i].selected = true;
                break;
            }
        }
    }

    // 根据月份推荐学期
    const semesterSelect = document.getElementById('{{ form.semester.id_for_label }}');
    if (semesterSelect) {
        let recommendedSemester = '';
        if (currentMonth >= 3 && currentMonth <= 8) {
            recommendedSemester = '第2学期';
        } else {
            recommendedSemester = '第1学期';
        }

        // 为推荐学期添加标记
        for (let i = 0; i < semesterSelect.options.length; i++) {
            const option = semesterSelect.options[i];
            if (option.value === recommendedSemester) {
                option.textContent += ' (推荐)';
            }
        }
    }
});
</script>
{% endblock %}