{% extends 'base.html' %}
{% block title %}{% if form.instance.pk %}编辑学生{% else %}添加学生{% endif %} - 学生信息管理系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h3><i class="fas fa-user-graduate"></i> {% if form.instance.pk %}编辑学生{% else %}添加学生{% endif %}</h3>
        <hr>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}

                    {% if form.errors %}
                        <div class="alert alert-danger">
                            <strong>错误！</strong> 请检查表单中的错误。
                        </div>
                    {% endif %}

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.student_id.id_for_label }}" class="form-label">学号 *</label>
                            <input type="text" class="form-control" id="{{ form.student_id.id_for_label }}"
                                   name="{{ form.student_id.name }}" value="{{ form.student_id.value|default:'' }}" required>
                            {% if form.student_id.errors %}
                                <div class="text-danger">
                                    {{ form.student_id.errors.0 }}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">将作为默认用户名</small>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.real_name.id_for_label }}" class="form-label">真实姓名 *</label>
                            <input type="text" class="form-control" id="{{ form.real_name.id_for_label }}"
                                   name="{{ form.real_name.name }}" value="{{ form.real_name.value|default:'' }}" required>
                            {% if form.real_name.errors %}
                                <div class="text-danger">
                                    {{ form.real_name.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.gender.id_for_label }}" class="form-label">性别 *</label>
                            <select class="form-control" id="{{ form.gender.id_for_label }}"
                                    name="{{ form.gender.name }}" required>
                                <option value="">请选择性别</option>
                                {% for value, label in form.gender.field.choices %}
                                    <option value="{{ value }}" {% if form.gender.value == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                            {% if form.gender.errors %}
                                <div class="text-danger">
                                    {{ form.gender.errors.0 }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.birth_date.id_for_label }}" class="form-label">出生日期</label>
                            <input type="date" class="form-control" id="{{ form.birth_date.id_for_label }}"
                                   name="{{ form.birth_date.name }}" value="{{ form.birth_date.value|default:'' }}">
                            {% if form.birth_date.errors %}
                                <div class="text-danger">
                                    {{ form.birth_date.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.user.id_for_label }}" class="form-label">关联用户</label>
                            <input type="text" class="form-control" id="{{ form.user.id_for_label }}"
                                   name="{{ form.user.name }}" value="{{ form.user.value|default:'' }}"
                                   readonly placeholder="系统自动关联">
                            <small class="form-text text-muted">创建学生档案后自动关联用户账号</small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.department.id_for_label }}" class="form-label">{{ form.department.label }}</label>
                            {{ form.department }}
                            {% if form.department.errors %}
                                <div class="text-danger">
                                    {{ form.department.errors.0 }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.major.id_for_label }}" class="form-label">{{ form.major.label }}</label>
                            {{ form.major }}
                            {% if form.major.errors %}
                                <div class="text-danger">
                                    {{ form.major.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.address.id_for_label }}" class="form-label">家庭住址</label>
                        <textarea class="form-control" id="{{ form.address.id_for_label }}"
                                  name="{{ form.address.name }}" rows="3">{{ form.address.value|default:'' }}</textarea>
                        {% if form.address.errors %}
                            <div class="text-danger">
                                {{ form.address.errors.0 }}
                            </div>
                        {% endif %}
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.emergency_contact.id_for_label }}" class="form-label">紧急联系人</label>
                            <input type="text" class="form-control" id="{{ form.emergency_contact.id_for_label }}"
                                   name="{{ form.emergency_contact.name }}" value="{{ form.emergency_contact.value|default:'' }}">
                            {% if form.emergency_contact.errors %}
                                <div class="text-danger">
                                    {{ form.emergency_contact.errors.0 }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.emergency_phone.id_for_label }}" class="form-label">紧急联系电话</label>
                            <input type="text" class="form-control" id="{{ form.emergency_phone.id_for_label }}"
                                   name="{{ form.emergency_phone.name }}" value="{{ form.emergency_phone.value|default:'' }}">
                            {% if form.emergency_phone.errors %}
                                <div class="text-danger">
                                    {{ form.emergency_phone.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{% url 'students:student_profile_list' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> 返回列表
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> 保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card bg-light">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> 操作说明</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="fas fa-check text-success"></i> 学号为必填项，将作为用户登录名
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success"></i> 系统会自动创建对应的用户账号
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success"></i> 默认密码为：123456
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success"></i> 用户角色自动设为"学生"
                    </li>
                    <li>
                        <i class="fas fa-check text-success"></i> 学生首次登录后建议修改密码
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for department-major联动 -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const departmentSelect = document.getElementById('{{ form.department.id_for_label }}');
    const majorSelect = document.getElementById('{{ form.major.id_for_label }}');

    // 院系专业数据
    const departmentMajorData = {
        {% for dept in departments %}
        '{{ dept.id }}': [
            {% for major in dept.major_set.all %}
            {
                'id': '{{ major.id }}',
                'name': '{{ major.name }}'
            },
            {% endfor %}
        ],
        {% endfor %}
    };

    // 存储当前选中的专业ID
    const currentMajorId = '{{ form.major.value|default:"" }}';
    const currentDepartmentId = '{{ form.department.value|default:"" }}';

    function updateMajorOptions(departmentId, keepCurrentMajor = false) {
        // 清空专业选择框
        majorSelect.innerHTML = '<option value="">请选择专业</option>';

        if (departmentId && departmentMajorData[departmentId]) {
            const majors = departmentMajorData[departmentId];
            majors.forEach(function(major) {
                const option = document.createElement('option');
                option.value = major.id;
                option.textContent = major.name;
                // 如果是之前选中的专业，则保持选中状态
                if (keepCurrentMajor && major.id === currentMajorId) {
                    option.selected = true;
                }
                majorSelect.appendChild(option);
            });
            majorSelect.disabled = false;
        } else {
            majorSelect.innerHTML = '<option value="">请先选择院系</option>';
            majorSelect.disabled = true;
        }
    }

    if (departmentSelect && majorSelect) {
        // 页面加载时初始化专业选项
        if (currentDepartmentId) {
            updateMajorOptions(currentDepartmentId, true);
        }

        departmentSelect.addEventListener('change', function() {
            const departmentId = this.value;
            updateMajorOptions(departmentId, false);
        });
    }
});
</script>
{% endblock %}